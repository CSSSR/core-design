const withPlugins = require('next-compose-plugins')
const withFonts = require('next-fonts')
const CompressionPlugin = require('compression-webpack-plugin')

const nextConfig = {
  webpack: (config, { dev }) => {
    const withImages = () => {
      config.module.rules.push({
        test: /\.(jpe?g|png|gif|webp|svg|ico)$/,
        use: [
          {
            loader: 'file-loader',
            options: {
              publicPath: '/_next',
              name: '[path][name]-[hash:8].[ext]',
            },
          },
        ],
      })
    }

    const withCompression = () => {
      if (!dev) {
        config.plugins.push(
          new CompressionPlugin({
            test: /\.js$|\.css$|\.html$/,
            threshold: 10240,
          }),
          new CompressionPlugin({
            test: /\.js$|\.css$|\.html$/,
            algorithm: 'brotliCompress',
            filename: '[path].br[query]',
            compressionOptions: { level: 11 },
            threshold: 10240,
          }),
        )
      }
    }

    withImages()
    withCompression()

    return config
  },
}

module.exports = withPlugins([withFonts], nextConfig)
